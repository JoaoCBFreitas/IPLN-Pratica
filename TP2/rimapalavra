#!/usr/bin/python3
"""
Script que dada uma palavra fornece uma lista de palavras que rimem
Opção -s = Palavras têm de rimar e ter sentido semelhante
Opção -a = Palavras têm de rimar
Opção -f = ficheiro de poemas
Opção -h = Ajuda
Opção -p = Preencher dicionario de rimas
"""
import os
import sys
from getopt import getopt
import re
from conversor import *
from tqdm import tqdm  # instalar modulo
import spacy  # instalar modulo + python -m spacy download pt_core_news_lg
import warnings
import pickle


class color:
    PURPLE = '\033[95m'
    CYAN = '\033[96m'
    DARKCYAN = '\033[36m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
    END = '\033[0m'


def ajuda():
    print(color.RED + color.BOLD + "Preencher Dicionario                - " +
          color.END + "rimaPalavra -p <wordlist.txt>")
    print(color.RED + color.BOLD + "Palavras que rimam sem contexto     - " +
          color.END + "rimaPalavra -a <palavra>")
    print(color.RED + color.BOLD + "Palavras que rimam com contexto     - " +
          color.END + "rimaPalavra -s <palavra>")
    print(color.RED + color.BOLD + "Versos que rimam entre si num poema - " +
          color.END + "rimaPalavra -f <poema.json>")
    print(color.RED + color.BOLD +
          "Ajuda                               - " + color.END + "rimaPalavra -h")


def preencheDicionario(nome):
    with open(nome) as f:
        txt = f.read()
        palavras = re.findall(r"\b([a-z\-]+)\b", txt,
                              re.IGNORECASE)
    f.close()
    dicionario = {}
    for palavra in tqdm(palavras):
        silword = get_ipa(get_stressed(get_syllables(palavra))).split('.')
        i = silword[-1][-2:]

        if i in dicionario.keys():
            lista = dicionario[i]
            lista.append(palavra)
            dicionario[i] = lista
        else:
            lista = [palavra]
            if lista is None:
                print("PALAVRA----------->"+palavra)
            dicionario[i] = lista
    return dicionario


def rimaPalavraContext(palavra, lista, nlp):
    contexto = []
    for word in tqdm(lista):
        tokens = nlp(palavra + " " + word)
        semantica = tokens[0].similarity(tokens[1])
        if semantica > 0.65:
            contexto.append(word)
    return contexto


def processaPalavras(ficheiro, palavra, ops):
    rimas = {}
    l = []
    rimas[palavra[0]] = l
    silword = get_ipa(get_stressed(get_syllables(palavra[0]))).split('.')
    chave = silword[-1][-2:]
    if '-a' in ops:
        l = ficheiro[chave]
        rimas[palavra[0]] = l
    else:  # ops =-s
        nlp = spacy.load("pt_core_news_lg")
        l = ficheiro[chave]
        lista = rimaPalavraContext(palavra[0], l, nlp)
        rimas[palavra[0]] = lista
    return rimas


warnings.filterwarnings(
    "ignore", message=r"\[W008\]", category=UserWarning)
ops, args = getopt(sys.argv[1:], "sfahp")
ops = dict(ops)
if len(args) > 1 or len(ops) > 1:
    print(color.CYAN + color.UNDERLINE +
          color.BOLD + "Output Inválido, use apenas uma opção e um argumento" + color.END)
    ajuda()
else:
    if '-h' in ops:
        ajuda()
    elif '-f' in ops:
        # Rimas em versos de poemas
        exit
    elif '-p' in ops:
        # Preencher dicionario
        dicionario = preencheDicionario(args[0])
        filename = 'dicionario'
        outfile = open(filename, 'wb')
        pickle.dump(dicionario, outfile)
        outfile.close()
    else:
        # Palavras que rimam com palavra dada
        infile = open('dicionario', 'rb')
        new_dict = pickle.load(infile)
        infile.close()
        print(processaPalavras(new_dict, args, ops))
